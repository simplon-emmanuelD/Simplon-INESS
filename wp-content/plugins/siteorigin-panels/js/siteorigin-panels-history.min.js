!function(t,e,i){var s=window.siteoriginPanels;s.model.historyEntry=Backbone.Model.extend({defaults:{text:"",data:"",time:null,count:1}}),s.collection.historyEntries=Backbone.Collection.extend({model:s.model.historyEntry,builder:null,maxSize:12,initialize:function(){this.on("add",this.onAddEntry,this)},addEntry:function(t,e){("undefined"==typeof e||null===e)&&(e=this.builder.getPanelsData());var i=new s.model.historyEntry({text:t,data:JSON.stringify(e),time:parseInt((new Date).getTime()/1e3),collection:this});this.add(i)},onAddEntry:function(t){if(this.models.length>1){var e=this.at(this.models.length-2);(t.get("text")===e.get("text")&&t.get("time")-e.get("time")<15||t.get("data")===e.get("data"))&&(this.remove(t),e.set("count",e.get("count")+1))}for(;this.models.length>this.maxSize;)this.shift()}}),s.dialog.history=s.view.dialog.extend({historyEntryTemplate:e.template(t("#siteorigin-panels-dialog-history-entry").html().panelsProcessTemplate()),entries:{},currentEntry:null,revertEntry:null,selectedEntry:null,dialogClass:"so-panels-dialog-history",events:{"click .so-close":"closeDialog","click .so-restore":"restoreSelectedEntry"},initializeDialog:function(){this.entries=new s.collection.historyEntries,this.on("open_dialog",this.setCurrentEntry,this),this.on("open_dialog",this.renderHistoryEntries,this)},render:function(){this.renderDialog(this.parseDialogContent(t("#siteorigin-panels-dialog-history").html(),{})),this.$("iframe.siteorigin-panels-history-iframe").load(function(){t(this).show()})},setRevertEntry:function(t){this.revertEntry=new s.model.historyEntry({data:JSON.stringify(t.getPanelsData()),time:parseInt((new Date).getTime()/1e3)})},setCurrentEntry:function(){this.currentEntry=new s.model.historyEntry({data:JSON.stringify(this.builder.model.getPanelsData()),time:parseInt((new Date).getTime()/1e3)}),this.selectedEntry=this.currentEntry,this.previewEntry(this.currentEntry),this.$(".so-buttons .so-restore").addClass("disabled")},renderHistoryEntries:function(){var e=this.$(".history-entries"),s=this;e.empty(),(this.currentEntry.get("data")!==this.revertEntry.get("data")||this.entries.models.length>0)&&t(this.historyEntryTemplate({title:i.loc.history.revert,count:1})).data("historyEntry",this.revertEntry).prependTo(e),this.entries.each(function(r){var n=s.historyEntryTemplate({title:i.loc.history[r.get("text")],count:r.get("count")});t(n).data("historyEntry",r).prependTo(e)}),t(this.historyEntryTemplate({title:i.loc.history.current,count:1})).data("historyEntry",this.currentEntry).addClass("so-selected").prependTo(e),e.find(".history-entry").click(function(){var i=t(this);e.find(".history-entry").not(i).removeClass("so-selected"),i.addClass("so-selected");var r=i.data("historyEntry");s.selectedEntry=r,s.selectedEntry.cid!==s.currentEntry.cid?s.$(".so-buttons .so-restore").removeClass("disabled"):s.$(".so-buttons .so-restore").addClass("disabled"),s.previewEntry(r)}),this.updateEntryTimes()},previewEntry:function(t){this.$("iframe.siteorigin-panels-history-iframe").hide(),this.$('form.history-form input[name="siteorigin_panels_data"]').val(t.get("data")),this.$("form.history-form").submit()},restoreSelectedEntry:function(){return this.$(".so-buttons .so-restore").hasClass("disabled")?!1:this.currentEntry.get("data")===this.selectedEntry.get("data")?(this.closeDialog(),!1):("restore"!==this.selectedEntry.get("text")&&this.entries.addEntry("restore",this.builder.model.getPanelsData()),this.builder.model.loadPanelsData(JSON.parse(this.selectedEntry.get("data"))),this.closeDialog(),!1)},updateEntryTimes:function(){var e=this;this.$(".history-entries .history-entry").each(function(){var i=t(this),s=i.find(".timesince"),r=i.data("historyEntry");s.html(e.timeSince(r.get("time")))})},timeSince:function(t){var e,s=parseInt((new Date).getTime()/1e3)-t,r=[];return s>3600&&(e=Math.floor(s/3600),1===e?r.push(i.loc.time.hour.replace("%d",e)):r.push(i.loc.time.hours.replace("%d",e)),s-=3600*e),s>60&&(e=Math.floor(s/60),1===e?r.push(i.loc.time.minute.replace("%d",e)):r.push(i.loc.time.minutes.replace("%d",e)),s-=60*e),s>0&&(1===s?r.push(i.loc.time.second.replace("%d",s)):r.push(i.loc.time.seconds.replace("%d",s))),0===r.length?i.loc.time.now:i.loc.time.ago.replace("%s",r.slice(0,2).join(", "))}})}(jQuery,_,soPanelsOptions);